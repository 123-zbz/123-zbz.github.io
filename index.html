<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>货运记录管理</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                    }
                }
            }
        }
    </script>
    <style>
        .suggestion-box {
            z-index: 10;
            max-height: 150px;
            overflow-y: auto;
        }
        .suggestion-item:hover {
            background-color: #f0f9ff;
        }
    </style>
</head>
<body class="bg-gray-50 p-4 md:p-6 max-w-5xl mx-auto">
    <header class="mb-6">
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold text-gray-800">货运记录管理</h1>
                <p class="text-gray-600">输入信息并导出为CSV</p>
            </div>
            <div class="flex items-center">
                <a href="https://freight-record-example.netlify.app" target="_blank"
                   class="flex items-center text-primary hover:underline text-sm">
                    <i class="fa fa-external-link mr-1"></i> 在新窗口打开
                </a>
            </div>
        </div>
    </header>

    <div class="grid md:grid-cols-2 gap-6">
        <!-- 表单区域 -->
        <div class="bg-white p-5 rounded-lg shadow">
            <h2 class="text-lg font-semibold mb-4">添加记录</h2>

            <form id="recordForm" class="space-y-3">
                <div>
                    <label class="block text-sm text-gray-700">CSV文件名</label>
                    <div class="flex">
                        <input type="text" id="filename" placeholder="文件名"
                            class="flex-1 px-3 py-2 border border-gray-300 rounded-l focus:outline-none focus:ring-1 focus:ring-primary">
                        <span class="bg-gray-100 px-3 py-2 border border-l-0 border-gray-300 rounded-r">.csv</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-gray-700">日期</label>
                        <input type="date" id="date" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-700">车号</label>
                        <div class="relative">
                            <input type="text" id="carNumber" placeholder="车号"
                                class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary">
                            <!-- 下拉提示框 -->
                            <div id="suggestionBox" class="suggestion-box absolute left-0 right-0 mt-1 bg-white border border-gray-300 rounded shadow hidden">
                                <!-- 提示项将动态添加 -->
                            </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-gray-700">起始地</label>
                        <input type="text" id="startPoint" placeholder="起始地"
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-700">终点</label>
                        <input type="text" id="endPoint" placeholder="终点"
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm text-gray-700">吨位</label>
                        <input type="number" id="tonnage" placeholder="0.00" min="0.01" step="0.01"
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                    <div>
                        <label class="block text-sm text-gray-700">单价(元/吨)</label>
                        <input type="number" id="price" placeholder="0.00" min="0.01" step="0.01"
                            class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-primary">
                    </div>
                </div>

                <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded hover:bg-primary/90 transition-colors">
                    <i class="fa fa-plus mr-1"></i>添加记录
                </button>
            </form>

            <div class="mt-4 space-y-2">
                <button id="exportBtn" class="w-full bg-secondary text-white py-2 px-4 rounded hover:bg-secondary/90 transition-colors" disabled>
                    <i class="fa fa-download mr-1"></i>导出CSV
                </button>
                <button id="clearBtn" class="w-full bg-danger text-white py-2 px-4 rounded hover:bg-danger/90 transition-colors" disabled>
                    <i class="fa fa-trash mr-1"></i>清空记录
                </button>
                <button id="clearVehiclesBtn" class="w-full bg-gray-600 text-white py-2 px-4 rounded hover:bg-gray-700 transition-colors" disabled>
                    <i class="fa fa-car mr-1"></i>清空车号记忆
                </button>
            </div>
        </div>

        <!-- 记录列表和车辆列表 -->
        <div class="space-y-6">
            <!-- 记录列表 -->
            <div class="bg-white p-5 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    记录列表 <span id="count" class="ml-2 text-sm bg-gray-100 px-2 py-0.5 rounded">0条</span>
                </h2>

                <div id="empty" class="py-8 text-center text-gray-500">
                    暂无记录
                </div>

                <div id="list" class="hidden max-h-[250px] overflow-y-auto">
                    <table class="min-w-full text-sm">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="px-2 py-2 text-left">日期</th>
                                <th class="px-2 py-2 text-left">车号</th>
                                <th class="px-2 py-2 text-left">总运费</th>
                                <th class="px-2 py-2 text-left">操作</th>
                            </tr>
                        </thead>
                        <tbody id="records"></tbody>
                    </table>
                </div>
            </div>

            <!-- 车辆列表 -->
            <div class="bg-white p-5 rounded-lg shadow">
                <h2 class="text-lg font-semibold mb-4 flex items-center">
                    已记录车号 <span id="vehicleCount" class="ml-2 text-sm bg-gray-100 px-2 py-0.5 rounded">0辆</span>
                </h2>

                <div id="vehiclesEmpty" class="py-4 text-center text-gray-500">
                    暂无车号记录
                </div>

                <div id="vehiclesList" class="hidden flex flex-wrap gap-2 max-h-[150px] overflow-y-auto">
                    <!-- 车辆标签将在这里动态显示 -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // 初始化变量 - 使用localStorage保存车辆信息
        let records = [];
        let vehicles = JSON.parse(localStorage.getItem('freightVehicles') || '[]');
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('date').value = today;

        // DOM元素
        const form = document.getElementById('recordForm');
        const filenameInput = document.getElementById('filename');
        const dateInput = document.getElementById('date');
        const carNumberInput = document.getElementById('carNumber');
        const suggestionBox = document.getElementById('suggestionBox');
        const startPointInput = document.getElementById('startPoint');
        const endPointInput = document.getElementById('endPoint');
        const tonnageInput = document.getElementById('tonnage');
        const priceInput = document.getElementById('price');
        const recordsEl = document.getElementById('records');
        const countEl = document.getElementById('count');
        const emptyEl = document.getElementById('empty');
        const listEl = document.getElementById('list');
        const exportBtn = document.getElementById('exportBtn');
        const clearBtn = document.getElementById('clearBtn');
        const clearVehiclesBtn = document.getElementById('clearVehiclesBtn');
        const vehiclesList = document.getElementById('vehiclesList');
        const vehiclesEmpty = document.getElementById('vehiclesEmpty');
        const vehicleCount = document.getElementById('vehicleCount');

        // 监听车号输入，显示匹配的建议
        carNumberInput.addEventListener('input', showSuggestions);

        // 点击页面其他地方关闭提示框
        document.addEventListener('click', (e) => {
            if (!carNumberInput.contains(e.target) && !suggestionBox.contains(e.target)) {
                suggestionBox.classList.add('hidden');
            }
        });

        // 表单提交
        form.addEventListener('submit', (e) => {
            e.preventDefault();

            // 简单验证
            if (!filenameInput.value || !carNumberInput.value || !startPointInput.value ||
                !endPointInput.value || !tonnageInput.value || !priceInput.value) {
                alert('请填写所有字段');
                return;
            }

            const tonnage = parseFloat(tonnageInput.value);
            const price = parseFloat(priceInput.value);
            if (tonnage <= 0 || price <= 0) {
                alert('吨位和单价必须大于0');
                return;
            }

            const carNumber = carNumberInput.value.trim();

            // 计算总运费
            const total = (tonnage * price).toFixed(2);

            // 添加记录
            const record = {
                id: Date.now(),
                date: dateInput.value,
                carNumber: carNumber,
                startPoint: startPointInput.value,
                endPoint: endPointInput.value,
                tonnage: tonnage.toFixed(2),
                price: price.toFixed(2),
                total: total
            };

            records.push(record);

            // 如果是新车辆，添加到车辆列表
            if (!vehicles.includes(carNumber)) {
                vehicles.push(carNumber);
                // 保存到localStorage
                localStorage.setItem('freightVehicles', JSON.stringify(vehicles));
            }

            updateUI();

            // 重置表单
            [carNumberInput, startPointInput, endPointInput, tonnageInput, priceInput].forEach(el => {
                el.value = '';
            });
            suggestionBox.classList.add('hidden');
        });

        // 导出CSV
        exportBtn.addEventListener('click', () => {
            if (records.length === 0) return;

            const filename = filenameInput.value.trim() + '.csv';
            const headers = ['日期', '车号', '起始地', '终点', '吨位', '单价', '总运费'];

            // 构建CSV内容
            const rows = [
                headers.join(','),
                ...records.map(r => [r.date, r.carNumber, r.startPoint, r.endPoint, r.tonnage, r.price, r.total].join(','))
            ];

            // 下载文件
            const blob = new Blob([rows.join('\n')], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        });

        // 清空记录
        clearBtn.addEventListener('click', () => {
            if (confirm('确定清空所有记录？（车号记忆不会被清除）')) {
                records = [];
                updateUI();
            }
        });

        // 清空车号记忆
        clearVehiclesBtn.addEventListener('click', () => {
            if (confirm('确定清空所有车号记忆？')) {
                vehicles = [];
                localStorage.setItem('freightVehicles', JSON.stringify(vehicles));
                updateUI();
            }
        });

        // 显示车号建议
        function showSuggestions() {
            const input = carNumberInput.value.trim();
            suggestionBox.innerHTML = '';

            if (!input || vehicles.length === 0) {
                suggestionBox.classList.add('hidden');
                return;
            }

            // 提取输入中的数字
            const inputNumbers = input.replace(/\D/g, '');

            if (!inputNumbers) {
                suggestionBox.classList.add('hidden');
                return;
            }

            // 找出包含相同数字的车号
            const suggestions = vehicles.filter(vehicle => {
                const vehicleNumbers = vehicle.replace(/\D/g, '');
                // 检查是否有共同的数字
                return inputNumbers.split('').some(num => vehicleNumbers.includes(num));
            });

            if (suggestions.length > 0) {
                // 添加建议项
                suggestions.forEach(vehicle => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item px-3 py-2 cursor-pointer hover:text-primary';
                    item.textContent = vehicle;
                    item.addEventListener('click', () => {
                        carNumberInput.value = vehicle;
                        suggestionBox.classList.add('hidden');
                    });
                    suggestionBox.appendChild(item);
                });
                suggestionBox.classList.remove('hidden');
            } else {
                suggestionBox.classList.add('hidden');
            }
        }

        // 删除记录
        window.deleteRecord = (id) => {
            records = records.filter(r => r.id !== id);
            updateUI();
        };

        // 更新界面
        function updateUI() {
            // 更新记录列表
            recordsEl.innerHTML = '';

            if (records.length === 0) {
                emptyEl.classList.remove('hidden');
                listEl.classList.add('hidden');
                exportBtn.disabled = true;
                clearBtn.disabled = true;
                countEl.textContent = '0条';
            } else {
                emptyEl.classList.add('hidden');
                listEl.classList.remove('hidden');
                exportBtn.disabled = false;
                clearBtn.disabled = false;
                countEl.textContent = `${records.length}条`;

                // 添加记录到表格
                records.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'border-t border-gray-100 hover:bg-gray-50';
                    row.innerHTML = `
                        <td class="px-2 py-2">${record.date}</td>
                        <td class="px-2 py-2">${record.carNumber}</td>
                        <td class="px-2 py-2">¥${record.total}</td>
                        <td class="px-2 py-2">
                            <button onclick="deleteRecord(${record.id})" class="text-danger text-sm">
                                <i class="fa fa-trash-o"></i> 删除
                            </button>
                        </td>
                    `;
                    recordsEl.appendChild(row);
                });
            }

            // 更新车号列表
            vehiclesList.innerHTML = '';

            if (vehicles.length === 0) {
                vehiclesEmpty.classList.remove('hidden');
                vehiclesList.classList.add('hidden');
                clearVehiclesBtn.disabled = true;
                vehicleCount.textContent = '0辆';
            } else {
                vehiclesEmpty.classList.add('hidden');
                vehiclesList.classList.remove('hidden');
                clearVehiclesBtn.disabled = false;
                vehicleCount.textContent = `${vehicles.length}辆`;

                // 添加车号标签
                vehicles.forEach(vehicle => {
                    const tag = document.createElement('span');
                    tag.className = 'inline-block bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full m-1';
                    tag.textContent = vehicle;
                    vehiclesList.appendChild(tag);
                });
            }
        }

        // 初始化界面
        updateUI();
    </script>
</body>
</html>
